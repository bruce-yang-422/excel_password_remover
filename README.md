# Excel 密碼移除工具

> ⚠️ **隱私安全提醒**：本工具處理的檔案可能包含商業機密和敏感資訊。請確保在安全的環境中使用，並妥善保管密碼檔案。詳見[隱私安全注意事項](#-隱私安全)。

## 專案簡介

本專案是一個自動化的 Excel 檔案密碼移除工具，專門用於批次處理受密碼保護的 Excel 檔案。透過 `msoffcrypto-tool` 函式庫，能夠安全且快速地移除 Excel 檔案的開啟密碼，並將解密後的檔案儲存至指定資料夾。

**新功能：智慧壓縮檔案處理**
- 📦 **壓縮檔案支援**：自動解壓縮 RAR 和 ZIP 檔案
- 🔍 **智慧密碼匹配**：根據密碼自動匹配對應店家，不限制檔案名稱
- 🔓 **雙重密碼處理**：支援壓縮檔案密碼和 Excel 檔案密碼
- 🎯 **智慧檔案識別**：自動識別並處理解壓縮後的 Excel 檔案

## 主要功能

- 🔓 **批次密碼移除**：自動處理 `input/` 資料夾內的所有 Excel 檔案
- 📦 **智慧壓縮檔案處理**：自動嘗試所有已知密碼解壓縮檔案，不限制檔案名稱
- 👥 **多帳號支援**：透過 YAML 設定檔管理多組帳號密碼對應
- 📝 **詳細記錄**：自動產生執行日誌，記錄處理結果和錯誤訊息
- 🛡️ **安全處理**：使用專業的加密函式庫確保資料安全
- 📊 **目錄樹生成**：內建專案結構視覺化工具
- 🔄 **智慧處理**：自動識別未加密檔案，直接複製而不報錯
- 🚀 **一鍵執行**：提供批次檔快速啟動，自動環境設定

## 專案結構

```
excel_password_remover/
├── main.py              # 主程式入口
├── run.bat              # 一鍵執行批次檔
├── passwords.yaml       # 密碼設定檔
├── requirements.txt     # Python 依賴套件
├── input/              # 待處理的 Excel 檔案和壓縮檔案
├── output/             # 解密後的檔案輸出
├── log/                # 執行日誌存放
└── scripts/
    ├── remover.py      # 密碼移除核心功能
    ├── compression.py  # 壓縮檔案處理功能
    ├── utils.py        # 工具函式
    └── tree.py         # 目錄樹生成工具
```

## 安裝需求

### 系統需求
- Python 3.7 或以上版本
- Windows/Linux/macOS 作業系統
- **RAR 檔案支援**：Windows 需要安裝 WinRAR 或 7-Zip

### 依賴套件
```
cffi==1.17.1
cryptography==45.0.4
et_xmlfile==2.0.0
msoffcrypto-tool==5.4.2
olefile==0.47
openpyxl==3.1.5
pycparser==2.22
PyYAML==6.0.2
rarfile==4.1
```

### 安裝步驟

#### 方法一：使用批次檔（推薦）
```bash
# 直接雙擊執行
run.bat
```
批次檔會自動：
- 檢查 Python 環境
- 建立虛擬環境
- 安裝依賴套件
- 執行程式

#### 方法二：手動安裝
```bash
# 1. 複製專案
git clone [專案網址]
cd excel_password_remover

# 2. 建立虛擬環境（建議）
python -m venv .venv
source .venv/bin/activate  # Linux/macOS
# 或
.venv\Scripts\activate     # Windows

# 3. 安裝依賴套件
pip install -r requirements.txt
```

## 使用方式

### 1. 準備檔案
將需要處理的檔案放入 `input/` 資料夾：
- Excel 檔案（.xlsx, .xls）
- 壓縮檔案（.zip, .rar）- 可使用任何檔名

### 2. 設定密碼對應
編輯 `passwords.yaml` 檔案，設定帳號與密碼的對應關係：

```yaml
excel_files:
  - name: 測試店家A
    account: testaccountA
    password: "123456"
  - name: 測試店家B
    account: testaccountB
    password: "654321"
  - name: 測試店家C
    account: testaccountC
    password: "abcdef"

compressed_files:
  - name: 測試購物平台A
    password: "12345678"
    account: "testcompA"
  - name: 測試購物平台B
    password: "87654321"
    account: "testcompB"
```

**設定說明：**

**Excel 檔案設定：**
- `name`：使用者名稱（用於日誌記錄）
- `account`：帳號識別碼（檔名需包含此字串）
- `password`：對應的 Excel 檔案開啟密碼

**壓縮檔案設定：**
- `name`：店家名稱（用於日誌記錄和資料夾命名）
- `password`：壓縮檔案密碼（程式會用此密碼嘗試解壓縮）
- `account`：對應的帳號識別碼（用於匹配解壓縮後的 Excel 檔案）

### 3. 執行程式

#### 使用批次檔（推薦）
```bash
# 雙擊執行
run.bat
```

#### 手動執行
```bash
python main.py
```

### 4. 查看結果
- 解密後的 Excel 檔案會儲存在 `output/` 資料夾
- 解壓縮的檔案會儲存在 `output/[檔名]_[店家名稱]_extracted/` 資料夾
- 執行日誌會儲存在 `log/` 資料夾，檔名格式：`execution_log_YYYYMMDD_HHMMSS.txt`

## 檔案處理流程

### Excel 檔案處理
1. 掃描 `input/` 資料夾中的 Excel 檔案
2. 根據檔名匹配對應的帳號密碼
3. 移除密碼並儲存到 `output/` 資料夾

### 智慧壓縮檔案處理
1. 掃描 `input/` 資料夾中的壓縮檔案（.zip, .rar）
2. **自動嘗試所有已知密碼**來解壓縮檔案
3. 成功匹配的檔案解壓縮到 `output/[檔名]_[店家名稱]_extracted/` 資料夾
4. 掃描解壓縮後的 Excel 檔案
5. **優先使用壓縮檔案的 account**處理 Excel 檔案
6. 處理 Excel 檔案密碼並儲存到 `output/` 資料夾

## 檔案命名規則

### Excel 檔案
程式會根據檔名中包含的 `account` 字串來匹配對應的密碼。例如：
- 檔案：`測試店家A_testaccountA_Order.all.20250602_20250702.xlsx`
- 對應：`account: testaccountA` 的密碼設定

### 壓縮檔案（智慧匹配）
程式會**自動嘗試所有已知密碼**來解壓縮檔案，不限制檔案名稱。例如：
- 檔案：`any_name.zip`（密碼：12345678）
- 自動匹配：`password: "12345678"` 的設定
- 解壓縮到：`output/any_name_測試購物平台A_extracted/`

## 智慧處理機制

### 智慧密碼匹配
- **不限制檔案名稱**：壓縮檔案可以使用任何檔名
- **自動密碼嘗試**：程式會按順序嘗試所有已知密碼
- **優先匹配**：解壓縮後的 Excel 檔案會優先使用壓縮檔案的 account

### 未加密檔案處理
- 自動識別未加密的 Excel 檔案
- 直接複製到 `output/` 資料夾，不報錯
- 在日誌中標記為成功處理

### 壓縮檔案處理
- 支援有密碼和無密碼的壓縮檔案
- 自動嘗試無密碼解壓縮
- 詳細記錄解壓縮結果

### 錯誤處理
- 自動跳過隱藏檔案（以 `.` 開頭）
- 詳細記錄處理失敗的原因
- 支援多帳號密碼自動比對
- 提供完整的執行狀態回饋

## 工具腳本

### 目錄樹生成工具
```bash
python scripts/tree.py
```
- 自動掃描專案資料夾結構
- 產生 `tree.txt` 檔案，方便文件記錄
- 自動排除 `.git`、`__pycache__` 等系統資料夾

## 執行日誌說明

程式會自動產生詳細的執行日誌，包含：
- ✅ 成功處理的檔案（包括解密和複製）
- 📦 成功解壓縮的壓縮檔案（包含匹配的店家名稱）
- ❌ 處理失敗的檔案及錯誤原因
- ⚠️ 未找到對應密碼的檔案
- ⚠️ 設定檔中有但未找到對應檔案的帳號

## 注意事項

### 🔒 隱私安全
1. **密碼保護**：請妥善保管 `passwords.yaml` 檔案，避免密碼外洩
   - 不要將密碼檔案上傳到公開的程式碼倉庫
   - 建議將 `passwords.yaml` 加入 `.gitignore` 檔案
   - 定期更換密碼，確保帳號安全
2. **檔案安全**：每次執行前會自動清空 `log/` 資料夾
   - 日誌檔案可能包含敏感資訊，請定期清理
   - 不要將日誌檔案分享給他人
3. **資料保護**：處理的檔案可能包含商業機密
   - 確保在安全的環境中使用本工具
   - 處理完成後及時刪除敏感檔案
   - 不要將處理後的檔案上傳到雲端儲存

### 📁 檔案處理
4. **檔案格式**：支援 Excel 檔案格式（.xlsx, .xls）和壓縮檔案格式（.zip, .rar）
5. **檔名規則**：Excel 檔名必須包含對應的 `account` 字串，壓縮檔案可使用任何檔名
6. **未加密檔案**：程式會自動處理未加密的檔案，直接複製到輸出資料夾
7. **RAR 檔案支援**：Windows 系統需要安裝 WinRAR 或 7-Zip 來支援 RAR 檔案處理
8. **密碼匹配順序**：程式會按照 `compressed_files` 的順序嘗試密碼

## 常見問題

### Q: 為什麼有些檔案顯示 "Unencrypted document" 錯誤？
A: 這表示該 Excel 檔案本身沒有加密保護。程式會自動將這些檔案複製到 `output/` 資料夾，不會影響處理流程。

### Q: 如何確認檔案是否有加密？
A: 用 Excel 開啟檔案，如果沒有要求輸入密碼，表示檔案未加密。

### Q: 批次檔執行失敗怎麼辦？
A: 請確認已安裝 Python，並檢查錯誤訊息。也可以手動執行 `python main.py` 來查看詳細錯誤。

### Q: RAR 檔案無法解壓縮怎麼辦？
A: 請確認已安裝 WinRAR 或 7-Zip，並確保系統 PATH 中包含相關程式。

### Q: 壓縮檔案中的 Excel 檔案如何處理？
A: 程式會自動解壓縮檔案，然後掃描其中的 Excel 檔案並進行密碼移除處理。

### Q: 壓縮檔案可以使用任何檔名嗎？
A: 是的！程式會根據密碼自動匹配對應的店家，不需要特定的檔案命名規則。

### Q: 如何保護密碼檔案的安全？
A: 請遵循以下安全措施：
- 將 `passwords.yaml` 加入 `.gitignore` 檔案（已預設包含）
- 不要將密碼檔案上傳到公開的程式碼倉庫
- 定期更換密碼，確保帳號安全
- 在安全的環境中使用本工具

### Q: 日誌檔案會記錄敏感資訊嗎？
A: 日誌檔案會記錄處理的檔案名稱和帳號資訊，但不包含密碼。建議：
- 定期清理 `log/` 資料夾
- 不要將日誌檔案分享給他人
- 處理完成後刪除敏感檔案

## 技術架構

- **核心解密**：使用 `msoffcrypto-tool` 函式庫
- **壓縮處理**：使用 `zipfile`（內建）和 `rarfile` 函式庫
- **設定管理**：YAML 格式設定檔
- **檔案處理**：Python `pathlib` 模組
- **日誌記錄**：自建日誌系統，支援中文編碼
- **智慧處理**：自動識別檔案加密狀態
- **密碼匹配**：智慧密碼嘗試機制

## 版本更新

### v1.3 (2025-08-01)
- 新增智慧密碼匹配功能，不限制壓縮檔案檔名
- 改善壓縮檔案處理流程，自動嘗試所有已知密碼
- 優先使用壓縮檔案的 account 處理 Excel 檔案
- 更新設定檔結構，移除檔案名稱限制

### v1.2 (2025-08-01)
- 新增壓縮檔案支援（RAR 和 ZIP）
- 新增雙重密碼處理機制
- 新增壓縮檔案解壓縮功能
- 改善檔案處理流程和日誌記錄

### v1.1 (2025-07-08)
- 新增智慧處理機制，自動處理未加密檔案
- 新增 `run.bat` 批次檔，一鍵執行
- 改善錯誤處理和日誌記錄
- 自動建立 `output/` 資料夾

### v1.0 (2025-07-02)
- 初始版本發布

## 授權說明

本專案由宜加寵物用品 Bruce 開發，版本 1.3 (2025-08-06)